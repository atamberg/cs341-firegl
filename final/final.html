<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="generator" content="pandoc">
    <meta name="description" content="">

    <title>FireGL - Fire Simulation in WebGL Final Report CS-341 2025</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/dashboard.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style type="text/css">code{white-space: pre;}</style>
    <style type="text/css">.sidebar ul{padding-left: 10px;}</style>
    <style type="text/css">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    </style>
    <link rel="stylesheet" href="css/cg_report.css" />
  </head>

  <body>

    <div class="container-fluid">
      <div class="row">
        <div id="sidebar" class="col-sm-3 col-md-2 sidebar">
          <!--<ul class="nav nav-sidebar">
            <li class="active"><a href="#">Overview <span class="sr-only">(current)</span></a></li>
          </ul>-->
          <ul>
          <li><a href="#firegl---fire-simulation-in-webgl"
          id="toc-firegl---fire-simulation-in-webgl">FireGL - Fire
          Simulation in WebGL</a>
          <ul>
          <li><a href="#abstract" id="toc-abstract">Abstract</a></li>
          <li><a href="#overview" id="toc-overview">Overview</a></li>
          <li><a href="#feature-validation"
          id="toc-feature-validation">Feature validation</a>
          <ul>
          <li><a href="#mesh-and-scene-design"
          id="toc-mesh-and-scene-design">Mesh and Scene Design</a></li>
          <li><a href="#bloom" id="toc-bloom">Bloom</a></li>
          <li><a href="#toon-shaders" id="toc-toon-shaders">Toon
          Shaders</a></li>
          <li><a href="#deferred-shading"
          id="toc-deferred-shading">Deferred Shading</a></li>
          <li><a href="#particle-effects"
          id="toc-particle-effects">Particle Effects</a></li>
          </ul></li>
          <li><a href="#discussion" id="toc-discussion">Discussion</a>
          <ul>
          <li><a href="#additional-components"
          id="toc-additional-components">Additional Components</a></li>
          <li><a href="#failed-experiments-missing-features"
          id="toc-failed-experiments-missing-features">Failed
          Experiments / Missing Features</a></li>
          <li><a href="#challenges"
          id="toc-challenges">Challenges</a></li>
          </ul></li>
          <li><a href="#contributions"
          id="toc-contributions">Contributions</a></li>
          <li><a href="#references"
          id="toc-references">References</a></li>
          </ul></li>
          </ul>
        </div>
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
        
<h1 id="firegl---fire-simulation-in-webgl">FireGL - Fire Simulation in
WebGL</h1>
<h2 id="abstract">Abstract</h2>
<p>This project simulates dynamic, stylized fire in a 3D forest scene
using WebGL. It combines deferred shading, toon lighting, and bloom
post-processing to produce visually distinct effects while maintaining
performance. Procedural scene generation and fire propagation systems
allow trees to ignite and spread fire based on proximity and time, with
visual transitions between normal, burning, and burned states. A
GPU-instanced particle system efficiently renders thousands of animated
fire and smoke particles efficiently. Users can interact with the
simulation by triggering fires. We validate our results through
side-by-side visual comparisons and limited performance tests.</p>
<h2 id="overview">Overview</h2>
<p>We set out to create a stylized interactive forest fire simulation.
Rather than focusing on physical realism, we aimed to model the essence
of fire, with glowing particles, exaggerated lighting effects, and
cartoon-inspired shading. The core idea was to use deferred shading to
efficiently handle hundreds of dynamic light sources, particles to
simulate fire behavior, bloom to create a glowing effect, and toon
shading for visual flair, all running on custom-designed scenes.</p>
<p>Scenes are populated with procedurally placed trees of varying types,
scales, and positions to create dense, organic-looking forests. Users
can initiate fires by pressing a key, triggering a system that spreads
flames from tree to tree based on distance and timing. Each tree
transitions through multiple states: normal, burning, and burned. These
transitions are accompanied by a mesh swap, cartoony animation, and
color shifts.</p>
<p>To model the fire itself, we implemented a custom particle system
with support for GPU instancing, allowing thousands of particles to be
animated each frame with minimal CPU overhead. These particles change
size, velocity, and color over their lifetimes, transitioning smoothly
between fire and smoke. Combined with bloom post-processing, bright
areas such as fire particles and light sources glow vividly, especially
in nighttime scenes. The final esthetic is further enhanced by toon
shading with edge outlines. The toon, thickly-outlined appearance is
similar to that of the game <em>Lethal Company</em>.</p>
<div style="text-align: center;">
<video src="videos/video-group64.mp4" width="700" controls></video>
<figcaption>
Our final video submission: Fire spreading, lighting effects, and
stylized visuals
</figcaption>
</div>
<div
style="display: flex; justify-content: center; gap: 20px; text-align: center;">
<figure>
<video src="videos/minifire.mp4" height="300px" playsinline autoplay loop muted>
</video>
<figcaption>
Close-up fire with cycling toon and bloom effects
</figcaption>
</figure>
<figure>
<video src="videos/firespread_closeup.mp4" height="300px" playsinline autoplay loop muted>
</video>
<figcaption>
Fire propagation system in action
</figcaption>
</figure>
</div>
<h2 id="feature-validation">Feature validation</h2>
<table>
<caption>
Feature Summary
</caption>
<thead>
<tr>
<th>
Feature
</th>
<th>
Adapted Points
</th>
<th>
Status
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Mesh and Scene Design
</td>
<td>
5
</td>
<td style="background-color: #d4edda;">
Completed
</td>
</tr>
<tr>
<td>
Bloom
</td>
<td>
5
</td>
<td style="background-color: #d4edda;">
Completed
</td>
</tr>
<tr>
<td>
Toon Shaders
</td>
<td>
10
</td>
<td style="background-color: #d4edda;">
Completed
</td>
</tr>
<tr>
<td>
Deferred Shading
</td>
<td>
15
</td>
<td style="background-color: #d4edda;">
Completed
</td>
</tr>
<tr>
<td>
Particle Effects
</td>
<td>
15
</td>
<td style="background-color: #d4edda;">
Completed
</td>
</tr>
</tbody>
</table>
<h3 id="mesh-and-scene-design">Mesh and Scene Design</h3>
<h4 id="implementation">Implementation</h4>
<h5 id="scene-design">Scene Design</h5>
<p>We created several scenes to test our features.</p>
<p><strong>Dynamic Lighting System</strong></p>
<p>In <code>deferred_scene.js</code>, we added dynamic lights that move
in orbital patterns:</p>
<ul>
<li><p><strong>Parametric Animation</strong>: Each light follows orbital
paths defined by parametric equations:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// deferred_scene.js</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>light<span class="op">.</span><span class="at">position</span>[<span class="dv">0</span>] <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">cos</span>(angle) <span class="op">*</span> radius<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>light<span class="op">.</span><span class="at">position</span>[<span class="dv">1</span>] <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(angle) <span class="op">*</span> radius<span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>light<span class="op">.</span><span class="at">position</span>[<span class="dv">2</span>] <span class="op">=</span> height <span class="op">+</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(angle <span class="op">*</span> <span class="dv">2</span>) <span class="op">*</span> amplitude<span class="op">;</span></span></code></pre></div></li>
<li><p><strong>Phase Offsets</strong>: Each light starts at a different
position in its orbit to avoid synchronized movement:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// deferred_scene.js</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> phase <span class="op">=</span> i <span class="op">*</span> (<span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">*</span> <span class="dv">2</span>) <span class="op">/</span> lightCount<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>angle <span class="op">=</span> (t <span class="op">*</span> speed) <span class="op">+</span> phase<span class="op">;</span></span></code></pre></div></li>
<li><p><strong>Random Variations</strong>: Lights have different orbit
sizes, heights, and speeds to make the scene more interesting:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// deferred_scene.js</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> radius</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> baseRadius <span class="op">+</span> (<span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> <span class="dv">2</span> <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> radiusVariation<span class="op">;</span></span></code></pre></div></li>
</ul>
<p><strong>Procedural Object Placement</strong></p>
<p>Our <code>generateTreePositions()</code> function (in
<code>mixed_forest_scene.js</code> and <code>models_scene.js</code>)
places trees randomly, avoiding collisions:</p>
<ul>
<li><p><strong>Collision Avoidance</strong>: We check distances between
trees to prevent them from overlapping:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// mixed_forest_scene.js</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> tooClose <span class="op">=</span> positions<span class="op">.</span><span class="fu">some</span>(p <span class="kw">=&gt;</span> {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dx <span class="op">=</span> p<span class="op">.</span><span class="at">x</span> <span class="op">-</span> x<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dy <span class="op">=</span> p<span class="op">.</span><span class="at">y</span> <span class="op">-</span> y<span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (dx <span class="op">*</span> dx <span class="op">+</span> dy <span class="op">*</span> dy) <span class="op">&lt;</span> (minDistance <span class="op">*</span> minDistance)<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div></li>
<li><p><strong>Random Properties</strong>: Trees get different sizes and
types for more variety:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// mixed_forest_scene.js</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> scale <span class="op">=</span> <span class="fl">0.5</span> <span class="op">+</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> <span class="fl">0.8</span><span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> treeType</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">&gt;</span> <span class="fl">0.7</span> <span class="op">?</span> <span class="st">&#39;TreeType2.obj&#39;</span> <span class="op">:</span> <span class="st">&#39;TreeType1.obj&#39;</span><span class="op">;</span></span></code></pre></div></li>
<li><p><strong>Spatial Optimization</strong>: We use a grid to reduce
the computational complexity of collision checks from O(n²) to O(n log
n), allowing us to place hundreds of trees efficiently.</p></li>
</ul>
<p><strong>Fire Spread System</strong></p>
<p><code>mixed_forest_scene.js</code> and <code>pine_scene.js</code>
include a fire system (<code>fire_spread.js</code>) that shows off our
particles (<em>explained later</em>) and lighting:</p>
<ul>
<li><p><strong>Object State Management</strong>: Each tree stores
multiple states (normal, burning, burned) with associated
properties:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// fire_spread.js</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>original_scale<span class="op">:</span> [scale<span class="op">,</span> scale<span class="op">,</span> scale]<span class="op">,</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>burned_scale<span class="op">:</span> [scale <span class="op">*</span> <span class="fl">2.5</span><span class="op">,</span> scale <span class="op">*</span> <span class="fl">2.5</span><span class="op">,</span> scale <span class="op">*</span> <span class="fl">2.5</span>]<span class="op">,</span></span></code></pre></div></li>
<li><p><strong>Parametric fire growth</strong><br />
Every <code>fireSpreadInterval</code> seconds we enlarge both particle
radius and light radius, clamping growth to keep it stable:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// fire_spread.js</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>fire<span class="op">.</span><span class="at">emission_radius</span> <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    fire<span class="op">.</span><span class="at">emission_radius</span> <span class="op">+</span> <span class="fl">0.3</span><span class="op">,</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">maxFireSpread</span>)<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (fire<span class="op">.</span><span class="at">emission_radius</span> <span class="op">&lt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">maxFireSpread</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    fire<span class="op">.</span><span class="at">particles_per_frame</span> <span class="op">*=</span> <span class="fl">1.2</span><span class="op">;</span> </span></code></pre></div></li>
<li><p><strong>Proximity-Based Propagation</strong>: A tree ignites when
its center falls inside a fire’s <code>burnZone</code> (flame radius ×
multiplier):</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// fire_spread.js</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> burnZone <span class="op">=</span> fire<span class="op">.</span><span class="at">emission_radius</span> <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">burnRadius</span><span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">dist</span>(firePosition<span class="op">,</span> obj<span class="op">.</span><span class="at">translation</span>) <span class="op">&lt;=</span> burnZone){</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">createTreeFire</span>(obj)<span class="op">;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p><strong>Burning Animation</strong>: Trees change appearance when
burning, swapping meshes and changing scale:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// fire_spread.js</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(time <span class="op">&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">burnDuration</span> <span class="op">-</span> <span class="op">.</span><span class="dv">5</span> <span class="op">&amp;&amp;</span> time <span class="op">&lt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">burnDuration</span>) {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    tree<span class="op">.</span><span class="at">material</span> <span class="op">=</span> MATERIALS<span class="op">.</span><span class="at">burntTree</span><span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    tree<span class="op">.</span><span class="at">mesh_reference</span> <span class="op">=</span> tree<span class="op">.</span><span class="at">mesh_reference</span> <span class="op">==</span> <span class="st">&#39;TreeType1.obj&#39;</span> <span class="op">?</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;DeadTreeType1.obj&#39;</span><span class="op">:</span> <span class="st">&#39;DeadTreeType2.obj&#39;</span><span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    vec3<span class="op">.</span><span class="fu">scale</span>(tree<span class="op">.</span><span class="at">scale</span><span class="op">,</span> tree<span class="op">.</span><span class="at">burned_scale</span><span class="op">,</span> <span class="fl">0.75</span> <span class="op">+</span> <span class="fl">0.25</span> <span class="op">*</span> </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        (time <span class="op">-</span> <span class="kw">this</span><span class="op">.</span><span class="at">burnDuration</span> <span class="op">+</span> <span class="fl">0.5</span>) <span class="op">/</span> <span class="op">.</span><span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p><strong>User Interaction</strong>: We implemented a ray-casting
system that converts screen coordinates to world positions, allowing
users to start fires by pressing a key on the keyboard.</p></li>
</ul>
<p><strong>User Interface</strong></p>
<p>All scenes include:</p>
<ul>
<li><p><strong>Parameter Display</strong>: A floating status box shows
the current state of boolean parameters:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// scene.js</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">updateStatusBox</span>() {</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> params <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getParamState</span>()<span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">statusBox</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">entries</span>(params)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">map</span>(([key<span class="op">,</span> value]) <span class="kw">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>key<span class="sc">}</span><span class="vs">: </span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&lt;br&gt;&#39;</span>)<span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p><strong>Keyboard Controls</strong>: Press keys to trigger actions
like starting fires:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// mixed_forest_scene.js</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">create_hotkey_action</span>(<span class="st">&quot;f&quot;</span><span class="op">,</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">startFireAtCursor</span>()<span class="op">,</span> <span class="st">&quot;Start fire at cursor&quot;</span>)<span class="op">;</span></span></code></pre></div></li>
</ul>
<h5 id="mesh-design">Mesh Design</h5>
<p>We designed the following meshes in Blender for our project: two
types of trees, each with a corresponding dead version, as well as a
terrain.</p>
<p>For the first tree type, we created a simple pine tree by starting
with a cylinder. We gradually reduced its diameter toward the top to
give it the appearance of a trunk. We then used cones to represent the
foliage. The dead version of this tree was designed similarly, but we
added extra branches to give the impression that they were “inside” the
cones.</p>
<p>For the second tree type, we included more branches and used
icospheres to represent the leaves, which created a visually nice
effect. Its dead version followed a similar structure, with additional
branches.</p>
<p>Starting with a thick rectangle, we added a displacement modifier
with a “cloud” texture to create a natural, uneven surface resembling
real terrain.</p>
<p>Finally, we baked the tree materials into texture images, allowing us
to preserve their colors in the project.</p>
<h4 id="validation">Validation</h4>
<h5 id="scene-design-1">Scene Design</h5>
<div style="text-align: center;">
<img src="images/mixed_forest_tree_generation_1.png" width="700" alt="Forest scene with procedural tree placement #1" />
<figcaption>
First example of procedurally placed trees in the forest scene
</figcaption>
</div>
<div style="text-align: center;">
<img src="images/mixed_forest_tree_generation_2.png" width="700" alt="Forest scene with procedural tree placement #2" />
<figcaption>
Second example showing different random tree placement
</figcaption>
</div>
<div style="text-align: center;">
<img src="images/deferred_scene.png" width="700" alt="Dynamic lighting in deferred scene" />
<figcaption>
Dynamic lighting with multiple orbital light sources
</figcaption>
</div>
<div style="text-align: center;">
<img src="images/models_scene.png" width="700" alt="Models scene with all meshes" />
<figcaption>
Dynamic lighting with multiple orbital light sources
</figcaption>
</div>
<div
style="display: flex; justify-content: center; gap: 20px; text-align: center;">
<figure>
<video src="videos/parameter_display.webm" width="350" playsinline autoplay loop muted>
</video>
<figcaption>
Close-up of Parameter Display Changing
</figcaption>
</figure>
<figure>
<video src="videos/firespread_closeup.mp4" width="350" playsinline autoplay loop muted>
</video>
<figcaption>
Close-up of Fire Spread
</figcaption>
</figure>
</div>
<h5 id="mesh-design-1">Mesh Design</h5>
Here is a comparison between our meshes rendered in Blender versus in
our project:
<h2 style="text-align:center;">
BLENDER vs. PROJECT
</h2>
<!-- Tree Type 1 -->
<div style="text-align:center; margin-bottom:2em;">
<img src="images/mesh_TreeType1.png" alt="Tree Type 1 – Blender" height="300" width="300" style="object-fit:cover;"/>
<img src="images/mesh_bTreeType1.png" alt="Tree Type 1 – Project" height="300" width="300" style="object-fit:cover;"/>
<p>
<em>Figure: Tree Type 1</em>
</p>
</div>
<!-- Tree Type 2 -->
<div style="text-align:center; margin-bottom:2em;">
<img src="images/mesh_TreeType2.png" alt="Tree Type 2 – Blender" height="300" width="300" style="object-fit:cover;"/>
<img src="images/mesh_bTreeType2.png" alt="Tree Type 2 – Project" height="300" width="300" style="object-fit:cover;"/>
<p>
<em>Figure: Tree Type 2</em>
</p>
</div>
<!-- Dead Tree Type 1 -->
<div style="text-align:center; margin-bottom:2em;">
<img src="images/mesh_DeadTreeType1.png" alt="Dead Tree Type 1 – Blender" height="300" width="300" style="object-fit:cover;"/>
<img src="images/mesh_bDeadTreeType1.png" alt="Dead Tree Type 1 – Project" height="300" width="300" style="object-fit:cover;"/>
<p>
<em>Figure: Dead Tree Type 1</em>
</p>
</div>
<!-- Dead Tree Type 2 -->
<div style="text-align:center; margin-bottom:2em;">
<img src="images/mesh_DeadTreeType2.png" alt="Dead Tree Type 2 – Blender" height="300" width="300" style="object-fit:cover;"/>
<img src="images/mesh_bDeadTreeType2.png" alt="Dead Tree Type 2 – Project" height="300" width="300" style="object-fit:cover;"/>
<p>
<em>Figure: Dead Tree Type 2</em>
</p>
</div>
<h3 id="bloom">Bloom</h3>
<h4 id="implementation-1">Implementation</h4>
<p>Our bloom implementation follows a multi-stage post-processing
pipeline that brightens areas of the scene with a glow effect. The
implementation consists of four key stages:</p>
<ol type="1">
<li><strong>Bright Pass Extraction</strong>: We first extract the bright
areas of the scene using a threshold-based filter in
<code>light_extraction.frag.glsl</code>. This shader calculates the
luminance of each pixel using the standard RGB-to-luminance conversion
weights (0.2126, 0.7152, 0.0722) and compares it against a configurable
threshold. Only pixels exceeding this threshold contribute to the bloom
effect, with their intensity scaled by a user-defined multiplier.</li>
</ol>
<div class="sourceCode" id="cb12"><pre
class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> brightness <span class="op">=</span> <span class="bu">dot</span><span class="op">(</span>color<span class="op">.</span><span class="fu">rgb</span><span class="op">,</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.2126</span><span class="op">,</span> <span class="fl">0.7152</span><span class="op">,</span> <span class="fl">0.0722</span><span class="op">));</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="op">(</span>brightness <span class="op">&gt;</span> u_threshold<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">gl_FragColor</span> <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>color<span class="op">.</span><span class="fu">rgb</span> <span class="op">*</span> u_intensity<span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">gl_FragColor</span> <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ol start="2" type="1">
<li><strong>Gaussian Blur</strong>: We apply a two-pass separable
Gaussian blur to the extracted bright areas using ping-pong rendering
between two framebuffers. This approach significantly improves
performance compared to a single-pass 2D blur by separating the
horizontal and vertical blur components. Our Gaussian kernel uses
pre-calculated weights for a 9-tap filter (4 samples on each side plus
the center pixel) to achieve a smooth blur effect while maintaining
performance.</li>
</ol>
<div class="sourceCode" id="cb13"><pre
class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Pre-calculated Gaussian weights for optimal performance</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">float</span> weight0 <span class="op">=</span> <span class="fl">0.227027</span><span class="op">;</span> <span class="co">// Center weight</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">float</span> weight1 <span class="op">=</span> <span class="fl">0.1945946</span><span class="op">;</span> <span class="co">// First offset weight</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">// ... weights for other samples</span></span></code></pre></div>
<p>The number of blur passes is configurable (default: 5), allowing us
to control the bloom radius without increasing the kernel size, which
would impact performance.</p>
<ol start="3" type="1">
<li><strong>Bloom Combination</strong>: The final stage combines the
original scene with the blurred bright areas using a modified additive
blend in <code>bloom_combine.frag.glsl</code>. We implemented a
luminance-aware blending formula that prevents color shifting when
multiple light sources are present:</li>
</ol>
<div class="sourceCode" id="cb14"><pre
class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> blendedColor</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> original<span class="op">.</span><span class="fu">rgb</span> <span class="op">+</span> bloomColor <span class="op">*</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> originalLuminance <span class="op">*</span> <span class="fl">0.5</span><span class="op">);</span></span></code></pre></div>
<p>This approach reduces the bloom contribution in already bright areas,
preventing over-saturation.</p>
<ol start="4" type="1">
<li><strong>Tone Adjustment</strong>: We have exposure control and soft
saturation adjustment to the final image to ensure the bloom effect
enhances the scene without creating unrealistic results:</li>
</ol>
<div class="sourceCode" id="cb15"><pre
class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> result <span class="op">=</span> blendedColor <span class="op">*</span> u_exposure<span class="op">;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> luminance <span class="op">=</span> <span class="bu">dot</span><span class="op">(</span>result<span class="op">,</span> <span class="dt">vec3</span><span class="op">(</span><span class="fl">0.2126</span><span class="op">,</span> <span class="fl">0.7152</span><span class="op">,</span> <span class="fl">0.0722</span><span class="op">));</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> saturationAdjusted <span class="op">=</span> <span class="bu">mix</span><span class="op">(</span><span class="dt">vec3</span><span class="op">(</span>luminance<span class="op">),</span> result<span class="op">,</span> <span class="fl">0.9</span><span class="op">);</span></span></code></pre></div>
<p>Our implementation uses floating-point textures throughout the
pipeline to preserve high dynamic range information, which is crucial
for realistic bloom effects. The entire process is encapsulated in the
<code>BloomShaderRenderer</code> class, which manages the framebuffers,
textures, and shader passes required for the effect.</p>
<h4 id="validation-1">Validation</h4>
<p>The bloom effect successfully enhances bright areas like fire
particles, light sources, and emissive materials without washing out the
scene. The effect is especially noticeable in night scenes, where bright
things glow.</p>
<p>We can configure the following with sliders: - Bloom threshold:
Controls which areas of the scene contribute to the bloom effect - Bloom
intensity: Adjusts the strength of the bloom effect - Exposure:
Fine-tunes the overall brightness of the final image</p>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">Scene without bloom effect
(daytime)</th>
<th style="text-align: center;">Scene with bloom effect enabled (default
parameters)</th>
</tr>
</thead>
<tbody>
<tr>
<td
style="text-align: center;"><img src="images/bloom_off.png" width="450" alt="Scene without bloom effect" /></td>
<td
style="text-align: center;"><img src="images/bloom_on_default_params.png" width="450" alt="Scene with bloom effect using default parameters" /></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">Night scene without bloom effect</th>
<th style="text-align: center;">Night scene with bloom effect</th>
</tr>
</thead>
<tbody>
<tr>
<td
style="text-align: center;"><img src="images/bloom_off_night.png" width="450" alt="Night scene without bloom effect" /></td>
<td
style="text-align: center;"><img src="images/bloom_on_night.png" width="450" alt="Night scene with bloom effect showing enhanced light sources" /></td>
</tr>
</tbody>
</table>
<h5 id="parameter-variations">Parameter Variations</h5>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">Low threshold: More scene elements
contribute to the bloom effect</th>
<th style="text-align: center;">High threshold: Only the brightest
elements bloom</th>
</tr>
</thead>
<tbody>
<tr>
<td
style="text-align: center;"><img src="images/bloom_on_low_threshold.png" width="450" alt="Bloom with low threshold" /></td>
<td
style="text-align: center;"><img src="images/bloom_on_high_threshold.png" width="450" alt="Bloom with high threshold" /></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">Low intensity: Subtle bloom effect</th>
<th style="text-align: center;">High intensity: Strong bloom effect</th>
</tr>
</thead>
<tbody>
<tr>
<td
style="text-align: center;"><img src="images/bloom_on_low_intensity.png" width="450" alt="Bloom with low intensity" /></td>
<td
style="text-align: center;"><img src="images/bloom_on_high_intensity.png" width="450" alt="Bloom with high intensity" /></td>
</tr>
</tbody>
</table>
<h3 id="toon-shaders">Toon Shaders</h3>
<h4 id="implementation-2">Implementation</h4>
<p>Our toon shader creates a cartoon look by using stepped lighting
instead of smooth gradients. We weren’t satisfied with just the toon
effect, so we added an outline filter too. Here’s how it works:</p>
<ol type="1">
<li><strong>Discretized Lighting</strong>: The core of our toon shader
is the discretization of diffuse and specular lighting components in
<code>toon.frag.glsl</code>. Rather than using smooth gradients, we
quantize these values into a configurable number of discrete bands:</li>
</ol>
<div class="sourceCode" id="cb16"><pre
class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Quantize diffuse lighting into discrete bands</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> diffuse_floor</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> <span class="bu">floor</span><span class="op">(</span>diffuse <span class="op">*</span> <span class="dt">float</span><span class="op">(</span>toon_levels<span class="op">))</span> <span class="op">/</span> <span class="dt">float</span><span class="op">(</span>toon_levels<span class="op">);</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> diffuse_ceil</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> diffuse_floor <span class="op">+</span> <span class="op">(</span><span class="fl">1.</span> <span class="op">/</span> <span class="dt">float</span><span class="op">(</span>toon_levels<span class="op">));</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>diffuse <span class="op">=</span> diffuse_floor <span class="op">+</span> <span class="op">(</span>diffuse_ceil <span class="op">-</span> diffuse_floor<span class="op">)</span> <span class="op">/</span> <span class="fl">2.</span><span class="op">;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Similarly quantize specular highlights</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> specular_floor</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> <span class="bu">floor</span><span class="op">(</span>specular <span class="op">*</span> <span class="dt">float</span><span class="op">(</span>toon_levels<span class="op">))</span> <span class="op">/</span> <span class="dt">float</span><span class="op">(</span>toon_levels<span class="op">);</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> specular_ceil <span class="op">=</span> specular_floor <span class="op">+</span> <span class="op">(</span><span class="fl">1.</span> <span class="op">/</span> <span class="dt">float</span><span class="op">(</span>toon_levels<span class="op">));</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>specular <span class="op">=</span> specular_floor <span class="op">+</span> <span class="op">(</span>specular_ceil <span class="op">-</span> specular_floor<span class="op">)</span> <span class="op">/</span> <span class="fl">2.</span><span class="op">;</span></span></code></pre></div>
<p>This approach creates the characteristic “stepped” appearance of toon
shading, where lighting changes occur in distinct jumps rather than
smooth transitions. The number of bands (<code>toon_levels</code>) is
configurable through the UI, allowing users to adjust the stylization
level from subtle (many bands) to extreme (few bands).</p>
<ol start="2" type="1">
<li><strong>Light Attenuation</strong>: We implemented a distance-based
attenuation model that maintains the stylized look while providing
realistic light falloff:</li>
</ol>
<div class="sourceCode" id="cb17"><pre
class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> light_distance <span class="op">=</span> <span class="bu">length</span><span class="op">(</span>light_position <span class="op">-</span> v2f_frag_pos<span class="op">);</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> attenuation <span class="op">=</span> <span class="bu">max</span><span class="op">(</span><span class="fl">0.</span><span class="op">,</span> <span class="fl">1.0</span> <span class="op">-</span> light_distance <span class="op">/</span> light_radius<span class="op">);</span></span></code></pre></div>
<p>This linear attenuation model is simpler than physically-based
attenuation but better suits the nature of toon shading.</p>
<ol start="3" type="1">
<li><strong>Light Combining</strong>: We add up the contributions from
multiple lights while keeping the cartoon look:</li>
</ol>
<div class="sourceCode" id="cb18"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">// toon_sr.js</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">blend</span>() {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use additive blending to accumulate light contributions</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">enable</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">func</span><span class="op">:</span> {</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">src</span><span class="op">:</span> <span class="st">&#39;one&#39;</span><span class="op">,</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>            <span class="dt">dst</span><span class="op">:</span> <span class="st">&#39;one&#39;</span><span class="op">,</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ol start="4" type="1">
<li><p><strong>Deferred Rendering</strong>: We created a deferred
version of the toon shader (<code>toon_deferred_sr.js</code>) that works
with our deferred pipeline. It gets lighting info from the G-buffer and
applies the same toon effect.</p></li>
<li><p><strong>Sobel Edge Detection</strong>: While our initial toon
shader implementation provided the characteristic banded lighting, we
found that it didn’t create sufficiently defined outlines for a true
cartoon look. To address this, we implemented a post-processing Sobel
filter in <code>sobel_outline.frag.glsl</code> that detects and
emphasizes object silhouettes based on depth discontinuities:</p></li>
</ol>
<div class="sourceCode" id="cb19"><pre
class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Sample neighboring pixels for depth</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> depth_right</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> <span class="dt">texture2D</span><span class="op">(</span>depth_texture<span class="op">,</span> v2f_uv <span class="op">+</span> <span class="dt">vec2</span><span class="op">(</span>texel<span class="op">.</span><span class="fu">x</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">)).</span><span class="fu">r</span><span class="op">;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> depth_left</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> <span class="dt">texture2D</span><span class="op">(</span>depth_texture<span class="op">,</span> v2f_uv <span class="op">+</span> <span class="dt">vec2</span><span class="op">(-</span>texel<span class="op">.</span><span class="fu">x</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">)).</span><span class="fu">r</span><span class="op">;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> depth_up</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> <span class="dt">texture2D</span><span class="op">(</span>depth_texture<span class="op">,</span> v2f_uv <span class="op">+</span> <span class="dt">vec2</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> texel<span class="op">.</span><span class="fu">y</span><span class="op">)).</span><span class="fu">r</span><span class="op">;</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> depth_down</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> <span class="dt">texture2D</span><span class="op">(</span>depth_texture<span class="op">,</span> v2f_uv <span class="op">+</span> <span class="dt">vec2</span><span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="op">-</span>texel<span class="op">.</span><span class="fu">y</span><span class="op">)).</span><span class="fu">r</span><span class="op">;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate depth differences</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> depth_diff_x <span class="op">=</span> <span class="bu">abs</span><span class="op">(</span>depth_right <span class="op">-</span> depth_left<span class="op">);</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> depth_diff_y <span class="op">=</span> <span class="bu">abs</span><span class="op">(</span>depth_up <span class="op">-</span> depth_down<span class="op">);</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate edge strength based on depth changes</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> edge_x <span class="op">=</span> <span class="bu">step</span><span class="op">(</span>depth_threshold<span class="op">,</span> depth_diff_x<span class="op">);</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> edge_y <span class="op">=</span> <span class="bu">step</span><span class="op">(</span>depth_threshold<span class="op">,</span> depth_diff_y<span class="op">);</span></span></code></pre></div>
<p>This gives us clean, sharp outlines around objects that really sell
the cartoon look. The <code>SobelOutlineShaderRenderer</code> adds these
outlines as a final step, so it works with both rendering methods.</p>
<p>The complete toon shader is implemented in
<code>ToonShaderRenderer</code> class. Objects can opt out of toon
shading by including the ‘no_toon’ property in their material
properties.</p>
<h4 id="validation-2">Validation</h4>
<p>The toon shader should work seamlessly with our other rendering
features - It should work with both forward and deferred rendering paths
with consistent visual results - It works with our particle systems,
creating stylized fire and smoke effects</p>
<p>We should be able to control the following parameters: - Toon levels:
Controls the number of discrete lighting bands - Outline threshold:
Adjusts the sensitivity of edge detection for outlines - Depth
threshold: Fine-tunes the depth difference required to detect an
edge</p>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">Standard Blinn-Phong shading</th>
<th style="text-align: center;">Default toon shading parameters</th>
</tr>
</thead>
<tbody>
<tr>
<td
style="text-align: center;"><img src="images/toon_off.png" width="450" alt="Standard scene with no toon shading" /></td>
<td
style="text-align: center;"><img src="images/toon_on_default.png" width="450" alt="Scene with default toon shading" /></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">Low number of light bands</th>
<th style="text-align: center;">High number of light bands</th>
</tr>
</thead>
<tbody>
<tr>
<td
style="text-align: center;"><img src="images/toon_on_low.png" width="450" alt="Toon shader with low quantization" /></td>
<td
style="text-align: center;"><img src="images/toon_on_high.png" width="450" alt="Toon shader with high quantization" /></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">Low Sobel threshold</th>
<th style="text-align: center;">High Sobel threshold</th>
</tr>
</thead>
<tbody>
<tr>
<td
style="text-align: center;"><img src="images/toon_on_sobel_low.png" width="450" alt="Toon shader with low threshold" /></td>
<td
style="text-align: center;"><img src="images/toon_on_sobel_high.png" width="450" alt="Toon shader with high threshold" /></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">Deferred rendering with standard
shading</th>
<th style="text-align: center;">Deferred rendering with toon
shading</th>
</tr>
</thead>
<tbody>
<tr>
<td
style="text-align: center;"><img src="images/toon_off_deferred.png" width="450" alt="Deferred rendering with standard shading" /></td>
<td
style="text-align: center;"><img src="images/toon_on_default_deferred.png" width="450" alt="Deferred rendering with toon shading" /></td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">Toon and bloom together day</th>
<th style="text-align: center;">Toon and bloom together night</th>
</tr>
</thead>
<tbody>
<tr>
<td
style="text-align: center;"><img src="images/toon_and_bloom.png" width="450" alt="Toon and bloom together" /></td>
<td
style="text-align: center;"><img src="images/toon_and_bloom_night.png" width="450" alt="Toon and bloom together at night" /></td>
</tr>
</tbody>
</table>
<p>We can see the sobels outlines with particles <a
href="#overview">here</a>. Since particles are not affected by any
lighting, toon levels do not change their appearance.</p>
<h3 id="deferred-shading">Deferred Shading</h3>
<h4 id="implementation-3">Implementation</h4>
<p>Our deferred shading pipeline uses a standard G-buffer, storing
camera-space position, normal, and albedo (material color) vectors,
along with a specular intensity scalar, in three color buffers inside
the G-buffer. We found storing camera-space vectors to be simpler for
our needs than storing world-space vectors like most tutorials
recommend. We then access the G-buffer while rendering all of our
deferred shaders.</p>
<p>To implement this feature, we primarily followed <a
href="https://github.com/regl-project/regl/blob/main/example/deferred_shading.js">this
Regl deferred shading example</a>, as well as the <a
href="https://learnopengl.com/Advanced-Lighting/Deferred-Shading">LearnOpenGL
Deferred Shading</a> guide.</p>
<h5 id="creating-the-g-buffer">Creating the G-buffer</h5>
<p>We created a <code>gBuffer</code> framebuffer in
<code>scene_renderer</code> with three color textures, and then, every
tick, rendered our <code>GBufferShaderRenderer</code> into it with
<code>gBuffer.use(...)</code>. (This is equivalent to
<code>regl({framebuffer: gBuffer})(...)</code>.) We also clear the
framebuffer each tick too. The G-buffer fragment shader writes to the
<code>gl_FragData[]</code> array which stores our data in the
framebuffer’s textures:</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">// gbuffer.frag.glsl</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="va">gl_FragData</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>material_color<span class="op">,</span> material_shininess<span class="op">);</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="va">gl_FragData</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span>vNormal<span class="op">);</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="va">gl_FragData</span><span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> vPosition<span class="op">;</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">// scene_renderer.js</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">gBuffer</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">regl</span><span class="op">.</span><span class="fu">framebuffer</span>({</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> [</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    regl<span class="op">.</span><span class="fu">texture</span>({ <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;float&#39;</span> })<span class="op">,</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    regl<span class="op">.</span><span class="fu">texture</span>({ <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;float&#39;</span> })<span class="op">,</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    regl<span class="op">.</span><span class="fu">texture</span>({ <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;float&#39;</span> })</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">gBuffer</span><span class="op">.</span><span class="fu">resize</span>(<span class="bu">window</span><span class="op">.</span><span class="at">innerWidth</span><span class="op">,</span> <span class="bu">window</span><span class="op">.</span><span class="at">innerHeight</span>)<span class="op">;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">gBuffer</span><span class="op">.</span><span class="fu">use</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">regl</span><span class="op">.</span><span class="fu">clear</span>({</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">255</span>]<span class="op">,</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">depth</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">gBuffer_renderer</span><span class="op">.</span><span class="fu">render</span>(scene_state)<span class="op">;</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h5 id="using-the-g-buffer">Using the G-buffer</h5>
<p>To use the G-buffer we created modifications of our shaders to take
the global <code>gBuffer</code> framebuffer as an argument in
<code>render()</code>. We index the <code>gBuffer.color[]</code> array
to access our geometry data. We use a unified vertex shader
<code>deferred.vert.glsl</code> to pass buffer data to all the inputs of
the deferred fragment shaders:</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">// deferred.vert.glsl</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">main</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">gl_Position</span> <span class="op">=</span> mat_model_view_projection <span class="op">*</span> <span class="dt">vec4</span><span class="op">(</span>vertex_positions<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    vPosition <span class="op">=</span> <span class="bu">gl_Position</span><span class="op">;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We compute the pixel coordinate <code>uv</code> from the
camera-projection position to extract data from the gBuffer
textures:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">// deferred/blinn_phong.frag.glsl</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="dt">vec2</span> uv <span class="op">=</span> <span class="op">(</span>vPosition<span class="op">.</span><span class="fu">xy</span> <span class="op">/</span> vPosition<span class="op">.</span><span class="fu">w</span> <span class="op">)</span> <span class="op">*</span> <span class="fl">0.5</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> v2f_frag_pos <span class="op">=</span> <span class="dt">texture2D</span><span class="op">(</span>positionBuffer<span class="op">,</span> uv<span class="op">).</span><span class="fu">xyz</span><span class="op">;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> v2f_normal <span class="op">=</span> <span class="dt">texture2D</span><span class="op">(</span>normalBuffer<span class="op">,</span> uv<span class="op">).</span><span class="fu">xyz</span><span class="op">;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> material_color <span class="op">=</span> <span class="dt">texture2D</span><span class="op">(</span>albedoSpecBuffer<span class="op">,</span> uv<span class="op">).</span><span class="fu">rgb</span><span class="op">;</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> material_shininess <span class="op">=</span> <span class="dt">texture2D</span><span class="op">(</span>albedoSpecBuffer<span class="op">,</span> uv<span class="op">).</span><span class="fu">a</span><span class="op">;</span></span></code></pre></div>
<h5 id="light-volumes">Light Volumes</h5>
<p>We rewrote the deferred version of the lighting shaders to use light
volumes. Instead of iterating over lights per object, each light is
represented as a sphere mesh, and shading is computed per fragment
within the light volume using additive blending and front-face culling.
We modified how ambient lighting and attenutation works, which we also
ported to the non-deferred shaders (without changing the original
computation) so that we could compare the two implementations more
easily.</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">// blinn_phong_deferred_sr.js</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">light_sphere</span> <span class="op">=</span> <span class="fu">mesh_make_uv_sphere</span>(<span class="dv">16</span>)<span class="op">;</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(scene_state<span class="op">,</span> gBuffer) {</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co">// renders a bunch of light spheres far more</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">// efficiently than the non-deferred implementation</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>scene<span class="op">.</span><span class="at">lights</span><span class="op">.</span><span class="fu">forEach</span>(light <span class="kw">=&gt;</span> {</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">.</span><span class="fu">push</span>({</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">mesh</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">light_sphere</span><span class="op">,</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">albedoSpec</span><span class="op">:</span> gBuffer<span class="op">.</span><span class="at">color</span>[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">normal</span><span class="op">:</span> gBuffer<span class="op">.</span><span class="at">color</span>[<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">position</span><span class="op">:</span> gBuffer<span class="op">.</span><span class="at">color</span>[<span class="dv">2</span>]<span class="op">,</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">mat_model_view_projection</span><span class="op">:</span> mat_model_view_projection<span class="op">,</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">light_color</span><span class="op">:</span> light<span class="op">.</span><span class="at">color</span><span class="op">,</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">light_position</span><span class="op">:</span> light_position_cam<span class="op">,</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">light_radius</span><span class="op">:</span> radius<span class="op">,</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">pipeline</span>(inputs)<span class="op">;</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h4 id="validation-3">Validation</h4>
<p>Here is a comparison between deferred and non-deferred shading, as
well the contents of the G-buffer in the same scene:</p>
<div style="text-align: center;">
<img src="images/deferred_disabled.png" width="700"/>
<figcaption>
Deferred Shading Disabled (Control)
</figcaption>
</div>
<div style="text-align: center;">
<img src="images/deferred_0.png" width="700"/>
<figcaption>
Deferred Shading Enabled
</figcaption>
</div>
<div style="text-align: center;">
<img src="images/deferred_disabled_toon.png" width="700"/>
<figcaption>
Deferred Shading Disabled (Toon) (Control)
</figcaption>
</div>
<div style="text-align: center;">
<img src="images/deferred_0_toon.png" width="700"/>
<figcaption>
Deferred Shading Enabled (Toon)
</figcaption>
</div>
<p>We can see very little, if any, difference between deferred and
non-deferred shading.</p>
<div
style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; text-align: center;">
<figure>
<img src="images/deferred_1.png" width="100%"/>
<figcaption>
Camera-space Position Buffer
</figcaption>
</figure>
<figure>
<img src="images/deferred_2.png" width="100%"/>
<figcaption>
Camera-space Normal Buffer
</figcaption>
</figure>
<figure>
<img src="images/deferred_3.png" width="100%"/>
<figcaption>
Albedo Colors
</figcaption>
</figure>
<figure>
<img src="images/deferred_4.png" width="100%"/>
<figcaption>
Specular Scalars
</figcaption>
</figure>
</div>
<p>Here’s a video cycling between deferred and non-deferred shading,
demonstrating the performance boost:</p>
<div style="text-align: center;">
<video src="videos/deferred_shading_performance.mp4" width="700" controls>
</video>
<figcaption>
Recorded using OBS on a AMD Ryzen 9 5900X and Nvidia RTX 3090 with 4x
CPU throttling (Chromium)
</figcaption>
</div>
<div
style="display: flex; justify-content: center; gap: 20px; text-align: center;">
<figure>
<img src="images/perf_deferred.png" width="700"/>
<figcaption>
Performance Graph with Deferred Shading (~1s interval)
</figcaption>
</figure>
<figure>
<img src="images/perf_not_deferred.png" width="700"/>
<figcaption>
Performance Graph without Deferred Shading (~1s interval)
</figcaption>
</figure>
</div>
<p>Over a ~1 second interval there are significantly more frames being
drawn using deferred shading and light volumes.</p>
<h3 id="particle-effects">Particle Effects</h3>
<h4 id="implementation-4">Implementation</h4>
<p>In order to make our fires a reality, we implemented a particle
system. We followed <a
href="https://www.opengl-tutorial.org/intermediate-tutorials/billboards-particles/">this
tutorial</a>, adapting it to the provided framework. Later, when
implementing GPU instancing, we found this <a
href="https://github.com/regl-project/regl/blob/b907a63bbb0d5307494657d4028ceca3b4615118/example/instance-mesh.js">Regl
GPU Instancing Example</a> very helpful.</p>
<h5 id="billboards">Billboards</h5>
<p>First, we implemented a basic billboard shader. The vertex shader
takes x and y coordinates of the model-world vertices of the billboard
mesh (a square plane) and maps them along the <code>cameraRight</code>
and <code>cameraUp</code> vectors in world-space (along with some
modifiable scale values), thereby forcing the top of the mesh to always
face the camera:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">// billboard.vert.glsl</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> cameraRight_worldspace <span class="op">=</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span><span class="op">(</span>mat_view<span class="op">[</span><span class="dv">0</span><span class="op">][</span><span class="dv">0</span><span class="op">],</span> mat_view<span class="op">[</span><span class="dv">1</span><span class="op">][</span><span class="dv">0</span><span class="op">],</span> mat_view<span class="op">[</span><span class="dv">2</span><span class="op">][</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> cameraUp_worldspace <span class="op">=</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec3</span><span class="op">(</span>mat_view<span class="op">[</span><span class="dv">0</span><span class="op">][</span><span class="dv">1</span><span class="op">],</span> mat_view<span class="op">[</span><span class="dv">1</span><span class="op">][</span><span class="dv">1</span><span class="op">],</span> mat_view<span class="op">[</span><span class="dv">2</span><span class="op">][</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> center_offset <span class="op">=</span> vertex_offset<span class="op">;</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> vertexPosition_worldspace <span class="op">=</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    center_offset</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> cameraRight_worldspace <span class="op">*</span> vertex_positions<span class="op">.</span><span class="fu">x</span> <span class="op">*</span> vertex_scale<span class="op">.</span><span class="fu">x</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> cameraUp_worldspace <span class="op">*</span> vertex_positions<span class="op">.</span><span class="fu">y</span> <span class="op">*</span> vertex_scale<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="bu">gl_Position</span> <span class="op">=</span> mat_mvp <span class="op">*</span> <span class="dt">vec4</span><span class="op">(</span>vertexPosition_worldspace<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span></code></pre></div>
<p>The fragment shader colors the mesh either with a uniform color or
with a texture:</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">// billboard.frag.glsl</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="dt">vec3</span> material_color <span class="op">=</span> vColor<span class="op">;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="op">(</span>is_textured<span class="op">){</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vec4</span> frag_color_from_texture <span class="op">=</span> <span class="dt">texture2D</span><span class="op">(</span>material_texture<span class="op">,</span> v2f_uv<span class="op">);</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// place color in transparent parts of texture</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    material_color <span class="op">=</span> frag_color_from_texture<span class="op">.</span><span class="fu">xyz</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> <span class="op">(</span><span class="fl">1.</span> <span class="op">-</span>frag_color_from_texture<span class="op">.</span><span class="fu">w</span><span class="op">)</span> <span class="op">*</span> vColor<span class="op">;</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="va">gl_FragColor</span> <span class="op">=</span> <span class="dt">vec4</span><span class="op">(</span>material_color<span class="op">,</span> <span class="fl">1.</span><span class="op">);</span> <span class="co">// output: RGBA in 0..1 range</span></span></code></pre></div>
<h5 id="particle-containers">Particle Containers</h5>
<p>Following the same tutorial, we created a particle container class
(<code>particle_container.js</code>) to manage the creation of thousands
of particles at a specific place. Each particle container behaves as a
mesh object but also has a list of particles to draw the mesh for
each:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">// particle_container.js</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">class</span> ParticleContainer {</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">constructor</span>(translation<span class="op">,</span> scale<span class="op">,</span> mesh_reference) {</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">translation</span> <span class="op">=</span> translation<span class="op">;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">scale</span> <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">mesh_reference</span> <span class="op">=</span> mesh_reference<span class="op">;</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">material</span> <span class="op">=</span> MATERIALS<span class="op">.</span><span class="at">particle_green</span><span class="op">;</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">color</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">material</span><span class="op">.</span><span class="at">color</span><span class="op">;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">particle_list</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">last_used_particle</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">particle_count</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">max_particles</span> <span class="op">=</span> <span class="dv">100000</span><span class="op">;</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">find_unused_particle</span>() {</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span> <span class="co">// algorithm taken from the tutorial</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// To be overrided in subclass</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">evolve</span>(dt) { }</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Some of these fields are likely unnecessary or weren’t fully used in
our project (e.g., <code>last_used_particle</code>, since
<code>find_unused_particle</code> also returns the index of the last
used particle).</p>
<p>To prevent a mesh from being rendered at the container’s base
position we excluded particles from all of the depth-related shaders
(e.g., <code>pre_processing_sr.js</code>, <code>map_mixer.js</code>) as
well as from the lighting shaders (e.g., <code>no_blinn_phong</code>
material property). Disabling shading is recommended for billboards but
not strictly necessary for other types of particle meshes.</p>
<h5 id="gpu-instancing">GPU Instancing</h5>
<p>If we just try to render a mesh iteratively over all the particles of
a container, things get really slow as a result of the number of calls
on the CPU (JavaScript side). The correct way to render the particles is
with GPU instancing, allowing us to upload particle data, such as
position offsets, colors, and sizes, in a single draw call per
container. All we need to do is enable the
<code>ANGLE_instanced_arrays</code> extension in <code>main.js</code>.
This optimization significantly improved rendering performance:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">// particles_sr.js</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(scene_state) {</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> obj <span class="kw">of</span> scene<span class="op">.</span><span class="at">objects</span>) {</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// using gpu instancing to push particle data into buffer</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">.</span><span class="fu">push</span>({</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">mesh</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">resource_manager</span><span class="op">.</span><span class="fu">get_mesh</span>(obj<span class="op">.</span><span class="at">mesh_reference</span>)<span class="op">,</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">particle_offsets</span><span class="op">:</span> {</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">buffer</span><span class="op">:</span> obj<span class="op">.</span><span class="at">particle_list</span><span class="op">.</span><span class="fu">map</span>(p <span class="kw">=&gt;</span> p<span class="op">.</span><span class="at">offset</span>)<span class="op">,</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">divisor</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">particle_colors</span><span class="op">:</span> {</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">buffer</span><span class="op">:</span> obj<span class="op">.</span><span class="at">particle_list</span><span class="op">.</span><span class="fu">map</span>(p <span class="kw">=&gt;</span> p<span class="op">.</span><span class="at">color</span>)<span class="op">,</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">divisor</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">particle_scale</span><span class="op">:</span> {</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">buffer</span><span class="op">:</span> obj<span class="op">.</span><span class="at">particle_list</span><span class="op">.</span><span class="fu">map</span>(p <span class="kw">=&gt;</span> p<span class="op">.</span><span class="at">scale_multiplier</span>)<span class="op">,</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">divisor</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>            <span class="dt">particle_count</span><span class="op">:</span> obj<span class="op">.</span><span class="at">particle_count</span><span class="op">,</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">pipeline</span>(inputs)</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a><span class="fu">attributes</span>(regl) {</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> attr <span class="op">=</span> <span class="kw">super</span><span class="op">.</span><span class="fu">attributes</span>(regl)<span class="op">;</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    attr<span class="op">.</span><span class="at">vertex_offset</span> <span class="op">=</span> regl<span class="op">.</span><span class="fu">prop</span>(<span class="st">&#39;particle_offsets&#39;</span>)<span class="op">;</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    attr<span class="op">.</span><span class="at">vertex_color</span> <span class="op">=</span> regl<span class="op">.</span><span class="fu">prop</span>(<span class="st">&#39;particle_colors&#39;</span>)<span class="op">;</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    attr<span class="op">.</span><span class="at">vertex_scale</span> <span class="op">=</span> regl<span class="op">.</span><span class="fu">prop</span>(<span class="st">&#39;particle_scale&#39;</span>)<span class="op">;</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> attr<span class="op">;</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a><span class="fu">init_pipeline</span>() {</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> regl <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">regl</span><span class="op">;</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">regl</span>({</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">instances</span><span class="op">:</span> regl<span class="op">.</span><span class="fu">prop</span>(<span class="st">&#39;particle_count&#39;</span>) <span class="co">// enable gpu instancing</span></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Each particle has an offset from the base particle container
position, a color if the container’s mesh doesn’t have a texture, and a
scale multipler to change size relative to the original size of the
mesh.</p>
<h5 id="fire-particles">Fire Particles</h5>
<p><code>fire_and_smoke.js</code> extends <code>ParticleContainer</code>
and provides a convincing effect with fiery colors and smoke.</p>
<ul>
<li><p><strong>Per-frame emission with cap</strong><br />
Up to <code>particles_per_frame</code> (45) new particles are spawned
each tick, but the cap guarantees we never exceed
<code>max_particles</code>:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">particles_per_frame</span><span class="op">;</span> <span class="op">++</span>i)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">emitParticle</span>()<span class="op">;</span>             </span></code></pre></div></li>
<li><p><strong>Spawn parameters</strong><br />
Each particle is born inside a disk of radius
<code>emission_radius</code> and given randomized velocity and offset
from its center:</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">// particle_system.js</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>particle<span class="op">.</span><span class="at">offset</span>[<span class="dv">0</span>]</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">cos</span>(random_angle) <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">emission_radius</span> <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>()<span class="op">;</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>particle<span class="op">.</span><span class="at">offset</span>[<span class="dv">1</span>]</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(random_angle) <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">emission_radius</span> <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>()<span class="op">;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>particle<span class="op">.</span><span class="at">velocity</span>[<span class="dv">0</span>]</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">cos</span>(random_angle) <span class="op">*</span> (<span class="fl">0.1</span> <span class="op">+</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> <span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>particle<span class="op">.</span><span class="at">velocity</span>[<span class="dv">1</span>]</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(random_angle) <span class="op">*</span> (<span class="fl">0.1</span> <span class="op">+</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> <span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>particle<span class="op">.</span><span class="at">velocity</span>[<span class="dv">2</span>] <span class="op">=</span> upward_speed<span class="op">;</span></span></code></pre></div></li>
<li><p><strong>Fire-to-smoke transition</strong><br />
The <code>smoke_chance</code> parameter decides whether a particle may
become smoke after it rises above <code>fire_height</code>:</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>particle<span class="op">.</span><span class="at">becomes_smoke</span>  <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">&lt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">smoke_chance</span><span class="op">;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> isSmoke <span class="op">=</span> particle<span class="op">.</span><span class="at">becomes_smoke</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> (particle<span class="op">.</span><span class="at">offset</span>[<span class="dv">2</span>] <span class="op">&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">fire_height</span>)<span class="op">;</span></span></code></pre></div></li>
<li><p><strong>Lifespan</strong><br />
A particle dies when:</p>
<ol type="1">
<li><code>life</code> ≤ 0,<br />
</li>
<li>it has existed longer than its <code>smoke_lifetime</code>, or<br />
</li>
<li>it exceeds a randomized fraction of <code>fire_height</code> or
<code>smoke_height</code>.</li>
</ol></li>
<li><p><strong>Realistic motion</strong> Fire particles move in a
zig-zag motion and with buoyancy:</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">//simple zigzag motion</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="op">!</span>isSmoke){</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> random_angle <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">*</span> <span class="dv">2</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    particle<span class="op">.</span><span class="at">velocity</span>[<span class="dv">0</span>] <span class="op">+=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">cos</span>(random_angle) <span class="op">*</span> <span class="fl">0.025</span><span class="op">;</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    particle<span class="op">.</span><span class="at">velocity</span>[<span class="dv">1</span>] <span class="op">+=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(random_angle) <span class="op">*</span> <span class="fl">0.025</span><span class="op">;</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    particle<span class="op">.</span><span class="at">velocity</span>[<span class="dv">2</span>] <span class="op">*=</span> <span class="fl">0.985</span><span class="op">;</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">//buoyancy effect</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="op">!</span>isSmoke){</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">//get the height ratio [0,1]</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> heightRatio <span class="op">=</span> particle<span class="op">.</span><span class="at">offset</span>[<span class="dv">2</span>] <span class="op">/</span> <span class="kw">this</span><span class="op">.</span><span class="at">fire_height</span><span class="op">;</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">//upward acceleration (stronger when lower)</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    particle<span class="op">.</span><span class="at">velocity</span>[<span class="dv">2</span>] <span class="op">+=</span> (<span class="fl">1.0</span> <span class="op">-</span> heightRatio) <span class="op">*</span> <span class="fl">4.0</span> <span class="op">*</span> slower_dt<span class="op">;</span> </span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p><strong>Height-based color grading</strong><br />
Linear interpolation (<code>lerp</code>) blends between three fire
colors (yellow → orange → red) or smoke colors (dark-red → gray → black)
based on height:</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">// fire example</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> heightRatio <span class="op">=</span> particle<span class="op">.</span><span class="at">offset</span>[<span class="dv">2</span>] <span class="op">/</span> <span class="kw">this</span><span class="op">.</span><span class="at">fire_height</span><span class="op">;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(heightRatio <span class="op">&lt;</span> <span class="fl">0.4</span>){</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//bottom yellow</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> t <span class="op">=</span> heightRatio <span class="op">/</span> <span class="fl">0.4</span><span class="op">;</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lerp</span>(particle<span class="op">.</span><span class="at">color</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">fire_colors</span>[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">fire_colors</span>[<span class="dv">1</span>]<span class="op">,</span> t)<span class="op">;</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">//orange to red</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> t <span class="op">=</span> (heightRatio <span class="op">-</span> <span class="fl">0.4</span>) <span class="op">/</span> <span class="fl">0.6</span><span class="op">;</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lerp</span>(particle<span class="op">.</span><span class="at">color</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">fire_colors</span>[<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">fire_colors</span>[<span class="dv">2</span>]<span class="op">,</span> t)<span class="op">;</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
</ul>
<h4 id="validation-4">Validation</h4>
<p>We can see fire particles in complete action in the <a
href="#overview">overview videos</a>.</p>
<div
style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; text-align: center;">
<figure>
<video src="videos/fire_closeup.mp4" width="350" playsinline autoplay loop muted>
</video>
<figcaption>
a Fire Particle Container
</figcaption>
</figure>
<figure>
<video src="videos/billboard.mp4" width="350" playsinline autoplay loop muted>
</video>
<figcaption>
Billboard with a texture
</figcaption>
</figure>
<figure>
<video src="videos/vomit_cropped.mp4" width="350" playsinline autoplay loop muted>
</video>
<figcaption>
Non-GPU Instanced Rainbow Vomit (video from milestone)
</figcaption>
</figure>
<figure>
<video src="videos/vomit_gpu.mp4" width="350" playsinline autoplay loop muted>
</video>
<figcaption>
GPU Instanced Rainbow Vomit
</figcaption>
</figure>
</div>
<p>Although GPU instancing hasn’t eliminated lag entirely,
(<code>evolve()</code> still runs entirely on the CPU), we see that
GPU-instanced particle rendering is significantly faster.</p>
<div
style="display: flex; justify-content: space-between; max-width: 800px; margin: auto; gap: 20px; text-align: center; align-items: flex-start;">
<figure>
<video src="videos/particle_color.mp4" width="226" autoplay loop muted playsinline>
</video>
<figcaption>
Color Changing Particle with a Semi-transparent Texture
</figcaption>
</figure>
<figure>
<video src="videos/particle_offset.mp4" width="226" autoplay loop muted playsinline>
</video>
<figcaption>
Changing offset relative to container origin (stationary particle)
</figcaption>
</figure>
<figure>
<video src="videos/particle_scale.mp4" width="226" autoplay loop muted playsinline>
</video>
<figcaption>
Changing size over time
</figcaption>
</figure>
</div>
<h2 id="discussion">Discussion</h2>
<h3 id="additional-components">Additional Components</h3>
<ul>
<li>Overlay for skybox for a toggleable night mode</li>
<li>We ported toon shaders to work with deferred shading.</li>
<li>Although we present it as part of our scene design, the fire spread,
generation, and other scene features not strictly about meshes could be
considered as add-ons.</li>
<li>We consider sobel outlines to be part of our toon shader
implementation, even though the original project instructions lists toon
shaders and outlines as separate features</li>
</ul>
<h3 id="failed-experiments-missing-features">Failed Experiments /
Missing Features</h3>
<ul>
<li><p><strong>Shadows</strong>: We disabled shadows due to performance
issues and visual conflicts with particles, toon outlines, and bloom.
Fire spread dynamically updates the number of light sources in a scene,
meaning that to update the shadows performantly we’d need an optimized
dynamic shadow system. We couldn’t afford to spend time on that before
completing our other features. A basic unoptimized version of deferred
shadows exists in the codebase</p></li>
<li><p><strong>Directional Lighting</strong>: We removed the ambient
component of the in our lighting shaders because it interfered with the
light volume system during blending. As a band-aid fix we used a faraway
point-light with a high light radius to reintroduce ‘ambient’ lighting.
Of course, this is not ideal for implementing a sun-like light since the
light rays aren’t parallel. Also, if we try to put the light source too
far away, the light volume is culled by the render distance limit. We
could’ve implemented a second type of light source that casts parallel
light rays onto the scene similar to what is in the <a
href="https://github.com/regl-project/regl/blob/main/example/deferred_shading.js">Regl
Deferred Shading Example</a></p></li>
</ul>
<h3 id="challenges">Challenges</h3>
<ul>
<li><p><strong>Adapting to the Framework</strong>: Understanding how to
adapt C++ code into the provided javascript framework was challenging,
and made harder by the fact that the framework did not follow the same
project layout as other Regl projects. Functional regl code in many
examples wasn’t always easily adaptable to the object-oriented,
de-functionalized framework. We weren’t always sure if the provided
utility functions did what some features required.</p></li>
<li><p><strong>Fire Particles</strong>: It was hard to make the fire
look real. At first, the particles flew straight up and it didn’t look
nice. We added a little wavy (zig-zag) motion and a gentle upward force
(buoyancy effect), then spent some time adjusting the colors until the
flames looked believable.</p></li>
<li><p><strong>Fire Spread</strong>: Tuning fire spread was tedious. We
had to figure out the right parameters in order to get a nice effect
while maintaining performance.</p></li>
<li><p><strong>Texture Baking</strong>: Texture baking was particularly
hard at the beginning, many tutorials were told us to use various
unwrapping options in Blender, but each time they made a mess. In the
end, we were able to bake the pine tree texture without any unwrapping
and then we just used photoshop for the second tree texture (our models
only have two colors).</p></li>
</ul>
<h2 id="contributions">Contributions</h2>
<table>
<caption>
Worked hours
</caption>
<thead>
<tr>
<th>
Name
</th>
<th>
Week 1
</th>
<th>
Week 2
</th>
<th>
Week 3
</th>
<th>
Week 4
</th>
<th>
Week 5
</th>
<th>
Week 6
</th>
<th>
Week 7
</th>
<th>
Total
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Leopold Popper
</td>
<td>
1
</td>
<td style="background-color: #f0f0f0;">
2
</td>
<td>
0
</td>
<td>
10
</td>
<td>
5
</td>
<td>
13
</td>
<td>
9
</td>
<td>
40
</td>
</tr>
<tr>
<td>
Ali Gorgani
</td>
<td>
1
</td>
<td style="background-color: #f0f0f0;">
1
</td>
<td>
0
</td>
<td>
11
</td>
<td>
4
</td>
<td>
11
</td>
<td>
12
</td>
<td>
36
</td>
</tr>
<tr>
<td>
Anthony Tamberg
</td>
<td>
1
</td>
<td style="background-color: #f0f0f0;">
0
</td>
<td>
0
</td>
<td>
9
</td>
<td>
6
</td>
<td>
14
</td>
<td>
12
</td>
<td>
42
</td>
</tr>
</tbody>
</table>
<table>
<caption>
Individual contributions
</caption>
<thead>
<tr>
<th>
Name
</th>
<th>
Contribution
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Leopold Popper
</td>
<td>
1/3
</td>
</tr>
<tr>
<td>
Ali Gorgani
</td>
<td>
1/3
</td>
</tr>
<tr>
<td>
Anthony Tamberg
</td>
<td>
1/3
</td>
</tr>
</tbody>
</table>
<h4 id="comments">Comments</h4>
<p>We had no issues splitting up the workload.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://github.com/regl-project/regl/blob/main/API.md">Regl
API</a></li>
<li><a
href="https://github.com/regl-project/regl/blob/b907a63bbb0d5307494657d4028ceca3b4615118/example/instance-mesh.js">Regl
GPU Instancing Example</a></li>
<li><a
href="https://github.com/regl-project/regl/blob/main/example/deferred_shading.js">Regl
Deferred Shading Example</a></li>
<li><a
href="https://learnopengl.com/Advanced-Lighting/Deferred-Shading">Deferred
Shading Tutorial</a></li>
<li><a
href="https://www.opengl-tutorial.org/intermediate-tutorials/billboards-particles/">Billboards
and Particles Tutorial</a></li>
<li><a href="https://learnopengl.com/Advanced-Lighting/Bloom">Bloom
Tutorial</a></li>
<li><a
href="https://learnopengl.com/In-Practice/2D-Game/Particles">Particles
(Fire)</a></li>
<li><a href="https://youtu.be/JE2Zmy088zc?si=zxaeML4sF3d6ACP1">Texture
Baking</a></li>
<li><a href="https://www.youtube.com/watch?v=h15kTY3aWaY">Toon Shading
Tutorial</a></li>
<li><a
href="https://en.wikibooks.org/wiki/GLSL_Programming/Unity/Toon_Shading">Toon
Shading Wiki</a></li>
<li><a href="https://www.shadertoy.com/view/4dVGRW">Toon and Sobel
Inspiration</a></li>
<li><a
href="https://www.vertexfragment.com/ramblings/unity-postprocessing-sobel-outline/#sobel-outlines-as-a-post-processing-effect">Sobel
Outline</a></li>
</ul>
<p><strong>Note</strong>: We used LLMs to find some resources and give
us ideas for implementing the more cosmetic parts of our project. For
example, using zig-zagging motions and buoyancy to make more realistic
fire. We also used AI for troubleshooting. We did not generate entire
chunks of code and paste them into our project. We used ChatGPT and
ClaudeAI.</p>
        </div>
      </div>
    </div>
    
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
    <script>
        //document.getElementById('sidebar').getElementsByTagName('ul')[0].className += "nav nav-sidebar";
        
        /* ajust the height when click the toc
           the code is from https://github.com/twbs/bootstrap/issues/1768
        */
        var shiftWindow = function() { scrollBy(0, -50) };
        window.addEventListener("hashchange", shiftWindow);
        function load() { if (window.location.hash) shiftWindow(); }
        
        /*add Bootstrap styles to tables*/
        var tables = document.getElementsByTagName("table");
        for(var i = 0; i < tables.length; ++i){
            tables[i].className += "table table-bordered table-hover";
        }
    </script>
  </body>
</html>
